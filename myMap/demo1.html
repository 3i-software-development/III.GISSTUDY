<html xmlns="http://www.w3.org/1999/xhtml">

<head>
  <script src="https://maps.googleapis.com/maps/api/js?sensor=false&libraries=geometry"></script>
  <script type="text/javascript">
    const geoJsonPath = './VN_Huyen.geojson';

    var geoJson = {};

    var markers = [];
    var polygons = [];
    var map;
    infoWindow = new google.maps.InfoWindow();
    window.onload = function () {
      ReadGeoJson();

      var mapOptions = {
        center: new google.maps.LatLng(16.030792969145363, 108.18368859282761),
        zoom: 12,
        mapTypeId: google.maps.MapTypeId.ROADMAP,
      };
      map = new google.maps.Map(document.getElementById("dvMap"), mapOptions);
      //Attach click event handler to the map.
      google.maps.event.addListener(map, "click", function (e) {
        CreateNewMarker(e.latLng, map);
      });
      AddPolygonByName("Cam Le");
    };
    //Create new marker
    function CreateNewMarker(location, map) {
      var marker = new google.maps.Marker({
        position: location,
        map: map,
        zIndex: 0
      });
      marker.addListener("click", ({ domEvent, latLng }) => {
        let contentString =
          "Clicked location: <br>" +
          'Latitude: ' + latLng.lat() +
          "," +
          '<br>' +
          'Longitude:' + latLng.lng() +
          "<br>";
        infoWindow.close();
        infoWindow.setContent(contentString);
        infoWindow.open(marker.map, marker);
      });
      marker.addListener("contextmenu", ({ domEvent, latLng }) => {
        const position = JSON.stringify(latLng);
        let contentString =
          "<button id='infoWindowButton' "
          + "onclick='DeleteMarker(" + position + ")'"
          + ">Delete </button>"
        infoWindow.close();
        infoWindow.setContent(contentString);
        infoWindow.open(marker.map, marker);
      });
      //Create a marker and placed it on the map.
      //Set title marker
      marker.setTitle(markers.length.toString());
      //Add marker to the array.
      markers.push(marker);
      return marker;
    }
    function DeleteMarker(position) {
      markers = markers.filter(element => {
        if (element.position.lat() === position.lat && element.position.lng() === position.lng) {
          // Remove the marker from the map
          element.setMap(null);
          // Return false to remove this element from the array
          return false;
        }
        // Return true to keep this element in the array
        return true;
      });

    }
    function DeleteAllMarkers() {
      //Loop through all the markers and remove
      for (var i = 0; i < markers.length; i++) {
        markers[i].setMap(null);
      }
      markers = [];
    }

    function SetPosition() {
      var marker1 = new google.maps.Marker({
        position: undefined,
        map: map,
      });

      markers.push(marker1);

      if (markers.length > 0) {
        DeleteMarkers();
      }

      let num = Math.floor(Math.random() * 32) + 0;
      locationS = new google.maps.LatLng(listLonLat[num][0], listLonLat[num][1]);
      marker1.position = locationS;
    }

    //setInterval(setPosition, 200);

    //và điểm trên polyline.
    function drawPolyline() {
      // Ở xóa polygon Cô
      var features = parkSourceVector.getSource().getFeatures();
      if (features != null && features.length > 0) {
        parkSourceVector.getSource().removeFeature(features[features.length - 1]);
      }
      ol.Observable.unByKey(eventCircleDraw);
      typeDraw = "Polygon";
      draw = new ol.interaction.Draw({
        source: parkSources,
        type: typeDraw,
      });
      map.addInteraction(draw);
    }
    //Ve marker tren maps
    function ReadGeoJson() {
      fetch(geoJsonPath)
        .then(response => response.json())
        .then(data => {
          geoJson = data;
        })
        .catch(error => {
          console.error('Error:', error);
        });
    }
    //bermudaTriangle.setMap(map);

    function AddPolygon() {
      var polygon = new google.maps.Data();
      geoJson.features.forEach(element => {
        polygon.addGeoJson(element);
        polygon.setMap(map);
        polygon.addListener("click", handlerPolygonOnClick);
        polygon.addListener("contextmenu", handlerPolygonContextMenu);
        polygon.setOptions({ zIndex: 1 });
        polygons.push(polygon)
      })
    }
    function AddPolygonByName(name) {
      var polygon = new google.maps.Data();
      geoJson.features.forEach(element => {
        if (element.properties.VARNAME_2 === name) {
          polygon.addGeoJson(element);
          polygon.setMap(map);
          polygon.addListener("click", handlerPolygonOnClick);
          polygon.addListener("contextmenu", handlerPolygonContextMenu);
          polygon.setOptions({ zIndex: 1 });
          polygons.push(polygon)
        }
      });
    }

    function handlerPolygonOnClick(event) {
      CreateNewMarker(event.latLng, map)
    }
    function handlerPolygonContextMenu(event) {
      // const polygon = this;
      //const vertices = polygon.getPath();
      let contentString =
        "<b>Bermuda Triangle polygon</b><br>" +
        "Clicked location: <br>" +
        event.latLng.lat() +
        "," +
        event.latLng.lng() +
        "<br>";
      infoWindow.setContent(contentString);
      infoWindow.setPosition(event.latLng);
      infoWindow.open(map);
    }
    function DeleteAllPolygons() {
      //Loop through all the markers and remove
      for (var i = 0; i < polygons.length; i++) {
        polygons[i].setMap(null);
      }
      polygons = [];
    }
  </script>
</head>
<;>
  <div id="dvMap" style="width: 100%; height: 500px"></div>
  <br />
  <input type="button" value="Delete" onclick="DeleteAllMarkers()" />

  <input type="button" value="Add marker" onclick="SetPosition()">
  <input type="button" value="Show all marker" onclick="ShowMarker()">
  <input type="button" value="Draw All" onclick="AddPolygon()">
  <input type="button" value="Delete all polygon" onclick="DeleteAllPolygon()">

  <div>
    <form onsubmit="AddPolygonByName(this.nameHuyen.value); return false;">
      <input type="text" placeholder="Nhập tên huyện" name="nameHuyen">
      <input type="submit" value="Submit">
    </form>
  </div>
  <div><input type="button" value="delete polygon" onclick="DeleteAllPolygons()" name="" id=""></div>
  </body>

</html>