<!DOCTYPE html>
<html>

<head>
    <title>OpenRouteService with Leaflet</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #map {
            height: 500px;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <div id="directions">
        <h2>Directions:</h2>
        <ul id="directions-list">
            <!-- Danh sách chỉ dẫn sẽ được hiển thị ở đây -->
        </ul>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Tạo bản đồ và đặt tọa độ trung tâm và mức thu phóng
        var map = L.map('map').setView([21.0285, 105.8269], 13);

        // Thêm bản đồ nền từ OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Tạo một lớp để chứa các điểm rẽ và điểm "Phố Hào Nam"
        var waypointsLayer = L.layerGroup().addTo(map);
        var haoNamMarker;

        // Tạo tuyến đường trên bản đồ và hiển thị chỉ dẫn
        function drawRoute(routeGeoJSON) {
            L.geoJSON(routeGeoJSON, {
                style: function (feature) {
                    return { color: 'blue' }; // Màu sắc của tuyến đường
                }
            }).addTo(map);

            // Hiển thị chỉ dẫn về tuyến đường trong danh sách
            var directionsList = document.getElementById('directions-list');
            directionsList.innerHTML = '';

            var instructions = routeGeoJSON.properties.segments[0].steps;
            if (instructions && instructions.length > 0) {
                instructions.forEach(function (instruction, index) {
                    var li = document.createElement('li');
                    li.textContent = instruction.instruction;
                    directionsList.appendChild(li);

                    // Hiển thị tọa độ các điểm rẽ
                    if (instruction.way_points && instruction.way_points.length > 0) {
                        var waypoint = instruction.way_points;
                        var marker = L.marker([waypoint[1], waypoint[0]]).addTo(waypointsLayer);
                        marker.bindPopup('Waypoint ' + index);
                    }

                    // Tìm kiếm tọa độ của "Phố Hào Nam" sau khi rẽ trái
                    if (instruction.instruction.includes('Turn left onto Phố Hào Nam')) {
                        // Gửi yêu cầu tìm kiếm địa điểm "Phố Hào Nam"
                        var searchUrl = 'https://nominatim.openstreetmap.org/search';
                        var searchQuery = 'Phố Hào Nam, Hanoi, Vietnam';

                        fetch(searchUrl + '?q=' + searchQuery + '&format=json')
                            .then(response => response.json())
                            .then(data => {
                                if (data.length > 0) {
                                    var haoNamCoords = [parseFloat(data[0].lon), parseFloat(data[0].lat)];
                                    // Hiển thị điểm "Phố Hào Nam" trên bản đồ
                                    haoNamMarker = L.marker(haoNamCoords).addTo(map);
                                    haoNamMarker.bindPopup('Phố Hào Nam');
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                            });
                    }
                });
            } else {
                // Trường hợp không có chỉ dẫn
                var li = document.createElement('li');
                li.textContent = 'No directions available.';
                directionsList.appendChild(li);
            }
        }

        // Gửi yêu cầu lấy tuyến đường từ OpenRouteService
        var apiKey = '5b3ce3597851110001cf6248889645833c6d4bfdbb493ecfb3f2590e';
        var coordinates = [[105.8269, 21.0285], [105.7979, 21.0587]];
        var url = 'https://api.openrouteservice.org/v2/directions/driving-car/geojson';

        fetch(url, {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + apiKey,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                coordinates: coordinates,
                instructions: 'true' // Yêu cầu chỉ dẫn
            })
        })
            .then(response => response.json())
            .then(data => {
                // Lấy tuyến đường từ dữ liệu và vẽ lên bản đồ
                var route = data.features[0];
                if (route) {
                    drawRoute(route);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    </script>
</body>

</html>
